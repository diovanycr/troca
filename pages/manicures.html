<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manicures - Gestão de Manicures</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="app-container">
    <header class="mobile-header">
      <button class="menu-toggle" id="menu-toggle">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <h1>Manicures</h1>
      <div style="width: 40px;"></div>
    </header>

    <div class="nav-overlay" id="nav-overlay"></div>
    <nav class="nav-drawer" id="nav-drawer">
      <div class="drawer-header">
        <div class="drawer-title">
          <h2>Parceiro</h2>
          <p>Sistema de Gestão</p>
        </div>
      </div>
      <div class="drawer-nav">
        <a href="../index.html" class="nav-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          <span>Dashboard</span>
        </a>
        <a href="manicures.html" class="nav-link active">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          <span>Manicures</span>
        </a>
        <a href="alerts.html" class="nav-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          <span>Alertas</span>
        </a>
      </div>
    </nav>

    <main class="main-content">
      <div class="page-header">
        <h2 class="page-title">Suas Parceiras</h2>
        <p class="page-subtitle" id="manicure-count">Carregando...</p>
      </div>

      <div class="section-card">
        <div class="form-group">
          <input type="text" id="search-input" placeholder="Buscar por nome ou telefone..." class="form-control">
        </div>
        <div class="item-list" id="manicures-list">
          <div class="empty-state">Carregando manicures...</div>
        </div>
      </div>
    </main>

    <button class="fab" onclick="window.location.href='new-manicure.html'">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    </button>
  </div>

  <div class="loading-spinner" id="loading-spinner"><div class="spinner"></div></div>

  <script type="module">
    import { dbManager } from '../js/database.js';
    import { auth } from '../config/firebase-config.js';

    let allManicures = [];

    const UI = {
      showLoading: () => document.getElementById('loading-spinner').classList.add('show'),
      hideLoading: () => document.getElementById('loading-spinner').classList.remove('show'),
      formatDate: (ts) => ts ? new Intl.DateTimeFormat('pt-BR').format(new Date(ts)) : 'N/A'
    };

    // Menu Toggle
    const menuToggle = document.getElementById('menu-toggle');
    const navDrawer = document.getElementById('nav-drawer');
    const navOverlay = document.getElementById('nav-overlay');

    menuToggle.onclick = () => {
      navDrawer.classList.toggle('open');
      navOverlay.classList.toggle('open');
    };
    navOverlay.onclick = () => {
      navDrawer.classList.remove('open');
      navOverlay.classList.remove('open');
    };

    async function loadManicures() {
      UI.showLoading();
      try {
        const data = await dbManager.getAllManicures();
        if (data) {
          allManicures = Object.keys(data).map(key => ({ id: key, ...data[key] }));
          renderList(allManicures);
        } else {
          document.getElementById('manicures-list').innerHTML = '<div class="empty-state">Nenhuma manicure cadastrada.</div>';
          document.getElementById('manicure-count').textContent = '0 manicures';
        }
      } catch (e) {
        console.error(e);
      } finally {
        UI.hideLoading();
      }
    }

    function renderList(list) {
      const container = document.getElementById('manicures-list');
      document.getElementById('manicure-count').textContent = `${list.length} manicures encontradas`;
      
      if (list.length === 0) {
        container.innerHTML = '<div class="empty-state">Nenhum resultado encontrado.</div>';
        return;
      }

      container.innerHTML = list.sort((a,b) => a.name.localeCompare(b.name)).map(m => `
        <div class="list-item" onclick="window.location.href='manicure-details.html?id=${m.id}'">
          <div class="item-info">
            <h3>${m.name}</h3>
            <p>${m.phone}</p>
          </div>
          <div class="item-status">
             <span class="badge ${m.nextExchangeDate < Date.now() ? 'badge-danger' : 'badge-success'}">
              ${m.nextExchangeDate < Date.now() ? 'Vencido' : 'Em dia'}
            </span>
          </div>
        </div>
      `).join('');
    }

    document.getElementById('search-input').oninput = (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allManicures.filter(m => 
        m.name.toLowerCase().includes(term) || 
        m.phone.includes(term)
      );
      renderList(filtered);
    };

    auth.onAuthStateChanged(user => {
      if (user) loadManicures();
      else window.location.href = 'login.html';
    });
  </script>
</body>
</html>
